<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with Custom Attributes and Summary Statistics in EpiModel • EpiModel</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with Custom Attributes and Summary Statistics in EpiModel">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EpiModel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/attributes-and-summary-statistics.html">Working with Custom Attributes and Summary Statistics in EpiModel</a></li>
    <li><a class="dropdown-item" href="../articles/Intro.html">EpiModel: Mathematical Modeling of Infectious Disease Dynamics</a></li>
    <li><a class="dropdown-item" href="../articles/model-parameters.html">Working with Model Parameters in EpiModel</a></li>
    <li><a class="dropdown-item" href="../articles/network-objects.html">Working with Network Objects in EpiModel</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EpiModel/EpiModel/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with Custom Attributes and Summary Statistics in EpiModel</h1>
                        <h4 data-toc-skip class="author">EpiModel
v2.5.0</h4>
            
            <h4 data-toc-skip class="date">2024-10-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/EpiModel/EpiModel/blob/main/vignettes/attributes-and-summary-statistics.Rmd" class="external-link"><code>vignettes/attributes-and-summary-statistics.Rmd</code></a></small>
      <div class="d-none name"><code>attributes-and-summary-statistics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette discusses some recent updates in <code>EpiModel</code>
on working with attributes and summary statistics within the stochastic
network model class. This material is oriented towards custom models
with extension modules and functions. Further details are provided in
the “New Network Models with EpiModel” section of <a href="https://www.epimodel.org/tut.html" class="external-link">the EpiModel tutorials</a>.</p>
<p>In network simulations with <code>netsim</code>, we store all data in
the <em>Main List Object</em> (referred to as <code>dat</code>). In this
vignette we will discuss with three types of data on
<code>dat</code>:</p>
<ul>
<li><em>Current Nodal Attributes</em></li>
<li><em>Historical Nodal Attributes</em></li>
<li><em>Epidemic Trackers</em></li>
</ul>
</div>
<div class="section level2">
<h2 id="current-nodal-attributes">Current Nodal Attributes<a class="anchor" aria-label="anchor" href="#current-nodal-attributes"></a>
</h2>
<p><em>Attributes</em> are characteristics of the nodes (e.g., persons)
in the model at the current time-step. By default, every node has a
<code>unique_id</code> and an <code>active</code> <em>attribute</em>
used to track each node, as well as three attributes used in the
epidemic modules: <code>status</code> for disease status,
<code>entrTime</code> for the time the node entered the population, and
<code>exitTime</code> for the time the node left the population. Other
attributes can be added of any name and value, like <code>age</code>,
but must be stored as a scalar values.</p>
<p>We work with <em>attribute vectors</em> that are all of the same size
of the number of nodes in the model. In the <em>attribute vectors</em>,
a node is identified by its <em>Positional ID</em> or
<code>posit_id</code> (i.e., the position in vector). The default
<em>attribute</em> <code>unique_id</code> created for each node gives a
unique identification number allowing us to refer to nodes no longer in
the model. Deaths or other forms of exit from the network disrupt the
positional ID but do not impact the unique ID.</p>
<div class="section level3">
<h3 id="working-with-attributes">Working With Attributes<a class="anchor" aria-label="anchor" href="#working-with-attributes"></a>
</h3>
<div class="section level4">
<h4 id="accessing-attributes">Accessing Attributes<a class="anchor" aria-label="anchor" href="#accessing-attributes"></a>
</h4>
<p>The <code><a href="../reference/net-accessor.html">EpiModel::get_attr</a></code> function will extract the vector
of a given <em>attribute</em>. In its simplest form, we can pull a
complete <em>attribute vector</em> from <code>dat</code> like so:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">active</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"active"</span><span class="op">)</span></span></code></pre></div>
<p>The above call will pull from <code>dat</code> the
<code>active</code> <em>attribute</em> for all nodes.
<code>active</code> is a vector of size <em>current number of
nodes</em>. With values being either 1 or 0 depending on whether a node
is active or not.</p>
<p>Trying to extract an <em>attribute</em> that does not exist will
cause <code><a href="../reference/net-accessor.html">EpiModel::get_attr</a></code> to throw an error.</p>
</div>
<div class="section level4">
<h4 id="modifying-attributes">Modifying Attributes<a class="anchor" aria-label="anchor" href="#modifying-attributes"></a>
</h4>
<p>In custom extension modules, we usually want to modify some of the
<em>attributes</em>. Below is a minimal module that increments the age
of all the nodes by 1.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aging_module</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Extract current attribute</span></span>
<span>  <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Aging process</span></span>
<span>  <span class="va">new_age</span> <span class="op">&lt;-</span> <span class="va">age</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Output updated attributes</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">set_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age"</span>, <span class="va">new_age</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s break down this very simple yet perfectly valid module.</p>
<ol style="list-style-type: decimal">
<li>Pull the <code>age</code> <em>attribute vector</em> as we did in the
previous section.</li>
<li>Create a vector <code>new_age</code> incrementing all ages by
one.</li>
<li>Update the <code>dat</code> object with the
<code><a href="../reference/net-accessor.html">EpiModel::set_attr</a></code> function.</li>
<li>Return the Updated <code>dat</code> object.</li>
</ol>
<p>We can see that <code><a href="../reference/net-accessor.html">EpiModel::set_attr</a></code> takes as
arguments:</p>
<ul>
<li>The <code>dat</code> object to update.</li>
<li>The name of the attribute vector of interest (here “age”).</li>
<li>The new values for this vector (here <code>new_age</code>).</li>
</ul>
<p>When using <code><a href="../reference/net-accessor.html">EpiModel::set_attr</a></code>, there are several things
to note:</p>
<ul>
<li>The function does not modify the <code>dat</code> object, it merely
returns a modified version of it to be assigned back to
<code>dat</code>. (Nicely, this does not cause performance issues due to
the way R handles shallow copies since version 3.1)</li>
<li>If <code>new_age</code> size is not equal to the number of nodes in
the network, the function will throw an error.</li>
</ul>
</div>
<div class="section level4">
<h4 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h4>
<p>The above example describes the recommended way to work with
attribute:</p>
<ol style="list-style-type: decimal">
<li>Extract the <em>attributes</em> into local vectors.</li>
<li>Modify the local vectors with some dynamic process (like
aging).</li>
<li>Update the <code>dat</code> object with the revised local
vectors.</li>
<li>Return the <code>dat</code> object at the end of the function.</li>
</ol>
<p>These functions have other arguments that are described in the
documentation: see
<code><a href="../reference/net-accessor.html">help("net-accessor", package = "EpiModel")</a></code> for further
details.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="historical-nodal-attributes">Historical Nodal Attributes<a class="anchor" aria-label="anchor" href="#historical-nodal-attributes"></a>
</h2>
<p>The <em>Attributes</em> described above refer to the state of
<strong>each node</strong> in the network <strong>at the current
time-step</strong>. However, it is sometimes useful to track of what
happened to nodes over time. Because saving the full history of the
<em>attributes</em> would consume too much memory and is rarely
necessary for full-scale research models, EpiModel offers a way to
record specific <em>attribute</em> for specific nodes at different
time-steps. These may be useful for diagnostic purposes (e.g., to see
that a dynamic process is coded correctly) or for tracking a limited set
of individual-level outcomes for further analysis.</p>
<p>The <em>Attribute History</em> is an efficient collection of recorded
attributes at different time-steps. EpiModel has functions to record
these elements and to access them in a convenient manner once the
<code>netsim</code> simulation is complete.</p>
<div class="section level3">
<h3 id="working-with-attribute-histories">Working with Attribute Histories<a class="anchor" aria-label="anchor" href="#working-with-attribute-histories"></a>
</h3>
<div class="section level4">
<h4 id="recording-attribute-histories">Recording Attribute Histories<a class="anchor" aria-label="anchor" href="#recording-attribute-histories"></a>
</h4>
<p>The following is a module that records the viral load of infected
nodes every 10 time steps. We assume that this module is part of a model
that defines and updates two <em>attributes</em> over time:</p>
<ul>
<li>
<code>status</code> with possible values being “infected” or
“susceptible”.</li>
<li>
<code>viral_load</code> as a continuous number for “infected” nodes
and <code>NA</code> otherwise.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">viral_load_logger_module</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Run every 10 time steps</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">at</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">10</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># Attributes</span></span>
<span>    <span class="va">status</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"status"</span><span class="op">)</span></span>
<span>    <span class="va">viral_load</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"viral_load"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">infected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"infected"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/record_attr_history.html">record_attr_history</a></span><span class="op">(</span></span>
<span>      <span class="va">dat</span>, <span class="va">at</span>,</span>
<span>      <span class="st">"viral_load"</span>,</span>
<span>      <span class="va">infected</span>,</span>
<span>      <span class="va">viral_load</span><span class="op">[</span><span class="va">infected</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Output</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The steps in the code are as follows:</p>
<ol style="list-style-type: decimal">
<li>Check that the current time step is a multiple of ten. If yes, go to
step 2, otherwise skip to step 5.</li>
<li>Pull the 2 <em>attribute vectors</em> of interest (“status” and
“viral_load”).</li>
<li>Store in <code>infected</code> the <code>posit_id</code>s of the
infected nodes.</li>
<li>Record the <code>viral_load</code> of <code>infected</code> nodes at
time <code>at</code> under the label “viral_load”.</li>
<li>Return the <code>dat</code> object.</li>
</ol>
<p><code><a href="../reference/record_attr_history.html">EpiModel::record_attr_history</a></code> takes five arguments:</p>
<ol style="list-style-type: decimal">
<li>The <code>dat</code> object.</li>
<li>The time step to be associated with the recording (here
<code>at</code>, the current time-step).</li>
<li>The label to be used for the attribute (here “viral_load”).</li>
<li>A vector of <code>posit_id</code>s referring to the nodes of
interest (here <code>infected</code>).</li>
<li>The values to be recorded for those IDs (here
<code>viral_load[infected]</code>)</li>
</ol>
<p>Note that <code><a href="../reference/record_attr_history.html">EpiModel::record_attr_history</a></code> requires a set
of <code>posit_id</code>s. Internally, the function will convert them to
<code>unique_id</code>s so the <em>Attribute History</em> will not be
affected by nodes entering or leaving the population over time.</p>
<p>When recording some attribute histories, one must ensure that we
record as many values as there are <code>posit_id</code>s. Otherwise,
the function will throw an error. It however possible to use only one
value for that attribute even if we record a value for multiple nodes.
This last situation actually uses less RAM. In any case, we would want
to record attribute histories sparingly as the storage can be large,
especially for open population models with many nodes that run over many
time steps.</p>
</div>
<div class="section level4">
<h4 id="accessing-the-attribute-histories">Accessing the Attribute Histories<a class="anchor" aria-label="anchor" href="#accessing-the-attribute-histories"></a>
</h4>
<p>The <em>Attribute History</em> is meant to be accessed once the
<code>netsim</code> simulation is complete. At that point, we can use
the <code><a href="../reference/get_attr_history.html">EpiModel::get_attr_history</a></code> function to access the
histories that we have recorded, like so:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/netsim.html">netsim</a></span><span class="op">(</span><span class="va">est</span>, <span class="va">param</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span>
<span><span class="va">attr_history</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/get_attr_history.html">get_attr_history</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<p>The <code>attr_history</code> object is a list of
<code>data.frame</code>s. One for each attribute history that was
recorded (we use this flexible list structure because each history may
be of different dimension). Assume that we were running two simulations,
using the module defined above and another one (not shown) recording
when a node switched from infected to recovered.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_attr_history.html">get_attr_history</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># $viral_load</span></span>
<span><span class="co">#    sim step attribute    uids values</span></span>
<span><span class="co"># 1  1   10   viral_load   1001   2000</span></span>
<span><span class="co"># 2  1   10   viral_load   1002   1878</span></span>
<span><span class="co"># 3  1   20   viral_load   1001   1500</span></span>
<span><span class="co"># 4  1   20   viral_load   1002    300</span></span>
<span><span class="co"># 5  2   10   viral_load    401   2500</span></span>
<span><span class="co"># 6  2   10   viral_load    402   1378</span></span>
<span><span class="co"># 7  2   20   viral_load    401   1200</span></span>
<span><span class="co"># 8  2   20   viral_load    402    100</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># $status</span></span>
<span><span class="co">#    sim step attribute      uids     values</span></span>
<span><span class="co"># 1  1   22   status  1001   infected</span></span>
<span><span class="co"># 2  1   64   status  1002   infected</span></span>
<span><span class="co"># 3  1  110   status  1001  recovered</span></span>
<span><span class="co"># 4  1  220   status  1002  recovered</span></span>
<span><span class="co"># 5  2    7   status   401   infected</span></span>
<span><span class="co"># 6  2   15   status   402   infected</span></span>
<span><span class="co"># 7  2   20   status   401  recovered</span></span>
<span><span class="co"># 8  2  120   status   402  recovered</span></span>
<span><span class="co"># ...</span></span></code></pre></div>
<p>We would get a named list of two <code>data.frame</code>’s:</p>
<ul>
<li>“viral_load” with the <code>value</code> column being the viral
loads.</li>
<li>“status” with the <code>value</code> column being whether the node
became “infected” or “recovered” at the given time-step.</li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="epidemic-trackers">Epidemic Trackers<a class="anchor" aria-label="anchor" href="#epidemic-trackers"></a>
</h2>
<p>The next type of data stored in <code>dat</code> is called an
<em>Epidemic Tracker</em>. This refers to some summary information about
the <em>population</em> at a specific time step. This information is
created and stored for <strong>each time step</strong>; therefore
epidemic trackers are historical summary statistics.</p>
<p>One example of an <em>Epidemic Trackers</em> is <code>num</code>,
present in any model, which stores the size of the population at each
time step.</p>
<div class="section level3">
<h3 id="working-with-epidemic-trackers-in-modules">Working With Epidemic Trackers in Modules<a class="anchor" aria-label="anchor" href="#working-with-epidemic-trackers-in-modules"></a>
</h3>
<p>Inside a module, <em>Epidemic Trackers</em> are accessed and modified
with the functions <code><a href="../reference/net-accessor.html">EpiModel::get_epi</a></code> and
<code><a href="../reference/net-accessor.html">EpiModel::set_epi</a></code>. Below is an updated new version of our
<code>aging_module</code> above with the addition of epidemic
trackers.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aging_track_module</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Attributes</span></span>
<span>  <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Aging process</span></span>
<span>  <span class="va">new_age</span> <span class="op">&lt;-</span> <span class="va">age</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Calculate summary statistics</span></span>
<span>  <span class="va">mean_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">new_age</span><span class="op">)</span></span>
<span>  <span class="va">prev_mean_age</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_epi</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span> <span class="op">-</span> <span class="fl">1</span>, <span class="st">"mean_age"</span><span class="op">)</span></span>
<span>  <span class="va">age_change</span> <span class="op">&lt;-</span> <span class="va">mean_age</span> <span class="op">-</span> <span class="va">prev_mean_age</span></span>
<span></span>
<span>  <span class="co"># Update nodal attributes</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">set_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age"</span>, <span class="va">new_age</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Update epidemic trackers</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/net-accessor.html">set_epi</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"mean_age"</span>, <span class="va">at</span>, <span class="va">mean_age</span><span class="op">)</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/net-accessor.html">set_epi</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age_change"</span>, <span class="va">at</span>, <span class="va">age_change</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this new module, in addition to incrementing the age of each node
by one, we also record two values as <em>Epidemic Trackers</em>: the
mean age of the population and the change in mean age compared to the
previous step (we could have calculated the latter after the simulation
was complete with <code>mutate_epi</code>, but here we do it on the fly
to demonstrate <code>get_epi</code>).</p>
<p>We extract the mean age at the previous time step using
<code><a href="../reference/net-accessor.html">EpiModel::get_epi</a></code> and set the second argument as
<code>at - 1</code>. After all the calculations are complete, we store
<code>mean_age</code> and <code>age_change</code> in <code>dat</code>
using <code><a href="../reference/net-accessor.html">EpiModel::set_epi</a></code>.</p>
<ul>
<li>Similarly to <code><a href="../reference/net-accessor.html">EpiModel::set_attr</a></code>, <code>dat</code> is
not modified directly and need to be assigned back to itself. Also, the
value we store must be a scalar.</li>
<li>Trying to access an <em>Epidemic Trackers</em> that do not exist
results in an error.</li>
</ul>
</div>
<div class="section level3">
<h3 id="accessing-epidemic-trackers-after-a-simulation">Accessing Epidemic Trackers After a Simulation<a class="anchor" aria-label="anchor" href="#accessing-epidemic-trackers-after-a-simulation"></a>
</h3>
<p><em>Epidemic Trackers</em> are usually the main quantities of
interest after a simulation has completed. We access them simply by
calling <code>as.data.frame</code> on a <code>netsim</code> object or by
using the plot or summary functions within by EpiModel. Note also that
you can perform derived summary statistic calculations after a
<code>netsim</code> call is complete with
<code><a href="../reference/mutate_epi.html">EpiModel::mutate_epi</a></code>.</p>
</div>
<div class="section level3">
<h3 id="custom-epidemic-trackers">Custom Epidemic Trackers<a class="anchor" aria-label="anchor" href="#custom-epidemic-trackers"></a>
</h3>
<p>It can be useful to create small <em>Epidemic Trackers</em> outside
of the modules and use them only when we need them. EpiModel will
automatically run the custom trackers passed to the
<code>.tracker.list</code> argument of <code>control.net</code>.</p>
<div class="section level4">
<h4 id="writing-tracker-functions">Writing Tracker Functions<a class="anchor" aria-label="anchor" href="#writing-tracker-functions"></a>
</h4>
<p>We call a <em>tracker function</em> a <code>function</code> that
takes <code>dat</code> as arguments and outputs a scalar value. Every
<em>tracker function</em> is run by <code><a href="../reference/netsim.html">EpiModel::netsim</a></code> at
each time step.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epi_s_num</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">needed_attributes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"status"</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="../reference/net-accessor.html">get_attr_list</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">needed_attributes</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"s"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>epi_s_num</code> function defined above is a <em>tracker
function</em>. It calculates at each time step the number of
<em>susceptible</em> nodes in the network.</p>
<p>The next example is a <em>tracker function</em> that calculates the
proportion of the population infected at each time step. Let’s look what
each element does:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epi_prop_infected</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># we need two attributes for our calculation: `status` and `active`</span></span>
<span>  <span class="va">needed_attributes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"status"</span>, <span class="st">"active"</span><span class="op">)</span></span>
<span>  <span class="co"># we use `with` to simplify code</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr_list</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">needed_attributes</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    <span class="va">pop</span> <span class="op">&lt;-</span> <span class="va">active</span> <span class="op">==</span> <span class="fl">1</span>    <span class="co"># we only look at active nodes</span></span>
<span>    <span class="va">cond</span> <span class="op">&lt;-</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"i"</span> <span class="co"># which are infected</span></span>
<span></span>
<span>    <span class="co"># how many are `infected` among the `active`</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cond</span> <span class="op">&amp;</span> <span class="va">pop</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pop</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We recommend that you write your <em>tracker functions</em> using
this format:</p>
<ol style="list-style-type: decimal">
<li>Define a <code>needed_attributes</code> variable containing a vector
of attribute names: in this example: “status” and “active”.</li>
<li>Use <code>with</code> and
<code>EpiModel::get_attr_list(dat, needed_attributes)</code> to work in
an environment with only the objects you need. This helps clarify what
the tracker does and simplify any debugging. We save the result of this
call into <code>output</code>.</li>
<li>The last statement in the <code>with</code> expression is what will
be stored in <code>output</code>. This <em>must</em> be a scalar.</li>
<li>
<code>return(output)</code>, what was calculated inside the
<code>with</code> construct.</li>
</ol>
</div>
<div class="section level4">
<h4 id="using-custom-tracker-functions">Using custom <em>tracker functions</em><a class="anchor" aria-label="anchor" href="#using-custom-tracker-functions"></a>
</h4>
<p>This functionality is enabled by passing the <em>tracker
functions</em> as a named list in <code>control.net</code>:
<code>.tracker.list</code>. Let’s make a simple SI epidemic model with
some added trackers:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the `tracker.list` list</span></span>
<span><span class="va">some.trackers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  prop_infected <span class="op">=</span> <span class="va">epi_prop_infected</span>,</span>
<span>  s_num         <span class="op">=</span> <span class="va">epi_s_num</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/control.net.html">control.net</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"SI"</span>,</span>
<span>  nsims <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  nsteps <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .tracker.list <span class="op">=</span> <span class="va">some.trackers</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/param.net.html">param.net</a></span><span class="op">(</span></span>
<span>  inf.prob <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  act.rate <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/network_initialize.html">network_initialize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_vertex_attribute.html">set_vertex_attribute</a></span><span class="op">(</span><span class="va">nw</span>, <span class="st">"race"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/netest.html">netest</a></span><span class="op">(</span></span>
<span>  <span class="va">nw</span>,</span>
<span>  formation <span class="op">=</span> <span class="op">~</span><span class="va">edges</span>,</span>
<span>  target.stats <span class="op">=</span> <span class="fl">25</span>,</span>
<span>  coef.diss <span class="op">=</span> <span class="fu"><a href="../reference/dissolution_coefs.html">dissolution_coefs</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting maximum pseudolikelihood estimation (MPLE):</span></span>
<span><span class="co">#&gt; Obtaining the responsible dyads.</span></span>
<span><span class="co">#&gt; Evaluating the predictor and response matrix.</span></span>
<span><span class="co">#&gt; Maximizing the pseudolikelihood.</span></span>
<span><span class="co">#&gt; Finished MPLE.</span></span>
<span></span>
<span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/init.net.html">init.net</a></span><span class="op">(</span>i.num <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/netsim.html">netsim</a></span><span class="op">(</span><span class="va">est</span>, <span class="va">param</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">d</span>, n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">sim</th>
<th align="right">time</th>
<th align="right">s.num</th>
<th align="right">i.num</th>
<th align="right">num</th>
<th align="right">si.flow</th>
<th align="right">prop_infected</th>
<th align="right">s_num</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">36</td>
<td align="right">1</td>
<td align="right">36</td>
<td align="right">27</td>
<td align="right">23</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.46</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td align="left">37</td>
<td align="right">1</td>
<td align="right">37</td>
<td align="right">27</td>
<td align="right">23</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.46</td>
<td align="right">27</td>
</tr>
<tr class="odd">
<td align="left">38</td>
<td align="right">1</td>
<td align="right">38</td>
<td align="right">26</td>
<td align="right">24</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.48</td>
<td align="right">26</td>
</tr>
<tr class="even">
<td align="left">39</td>
<td align="right">1</td>
<td align="right">39</td>
<td align="right">26</td>
<td align="right">24</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.48</td>
<td align="right">26</td>
</tr>
<tr class="odd">
<td align="left">40</td>
<td align="right">1</td>
<td align="right">40</td>
<td align="right">25</td>
<td align="right">25</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.50</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="left">41</td>
<td align="right">1</td>
<td align="right">41</td>
<td align="right">25</td>
<td align="right">25</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.50</td>
<td align="right">25</td>
</tr>
<tr class="odd">
<td align="left">42</td>
<td align="right">1</td>
<td align="right">42</td>
<td align="right">25</td>
<td align="right">25</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.50</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="left">43</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">24</td>
<td align="right">26</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.52</td>
<td align="right">24</td>
</tr>
<tr class="odd">
<td align="left">44</td>
<td align="right">1</td>
<td align="right">44</td>
<td align="right">24</td>
<td align="right">26</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.52</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="left">45</td>
<td align="right">1</td>
<td align="right">45</td>
<td align="right">23</td>
<td align="right">27</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.54</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="left">46</td>
<td align="right">1</td>
<td align="right">46</td>
<td align="right">23</td>
<td align="right">27</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.54</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="left">47</td>
<td align="right">1</td>
<td align="right">47</td>
<td align="right">23</td>
<td align="right">27</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.54</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="left">48</td>
<td align="right">1</td>
<td align="right">48</td>
<td align="right">22</td>
<td align="right">28</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.56</td>
<td align="right">22</td>
</tr>
<tr class="even">
<td align="left">49</td>
<td align="right">1</td>
<td align="right">49</td>
<td align="right">22</td>
<td align="right">28</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0.56</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="left">50</td>
<td align="right">1</td>
<td align="right">50</td>
<td align="right">21</td>
<td align="right">29</td>
<td align="right">50</td>
<td align="right">1</td>
<td align="right">0.58</td>
<td align="right">21</td>
</tr>
</tbody>
</table>
<p>Each function must be named in the <code>.tracker.list</code> list.
The name given there will be used to identify the <em>tracker
function</em> in the <code>epi</code> list and will be the name of the
corresponding column of the <code>data.frame</code> produced by
<code>as.data.frame(sim)</code> where <code>sim</code> is a
<code>netsim</code> object.</p>
<p><em>Note</em>: in the <code>some.trackers</code> list, we put
<code>epi_prop_infected</code> and <code>epi_s_num</code> without
parentheses at the end. This is because we store the
<code>function</code> and not the result of calling the function.</p>
<p><strong>Important</strong>: The trackers are <strong>Always</strong>
run at the end of a simulation step. The value outputted reflect the
state of the simulation <em>after</em> all the modules performed their
tasks.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="record-any-object-advanced-debugging">Record Any Object (Advanced Debugging)<a class="anchor" aria-label="anchor" href="#record-any-object-advanced-debugging"></a>
</h2>
<p>When working with complex research-level models, we sometimes want to
inspect the state of an object without stopping the simulation. The
function <code><a href="../reference/record_raw_object.html">EpiModel::record_raw_object</a></code> allows the user to
save any object during the simulation.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">introspect_module</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Attributes</span></span>
<span>  <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">age</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>        age <span class="op">=</span> <span class="va">age</span>,</span>
<span>        status <span class="op">=</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/net-accessor.html">get_attr</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"status"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu"><a href="../reference/record_raw_object.html">record_raw_object</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">at</span>, <span class="st">"old pop"</span>, <span class="va">obj</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this module, we look at the age of the population and if the mean
age is more than 50, we create a <code>data.frame</code> called
<code>obj</code> containing the <code>age</code> and <code>status</code>
<em>attribute vectors</em> and store it in a <em>Raw Record</em>.</p>
<p>This <em>Raw Record</em> can be accessed in the final
<code>netsim</code> object for debugging purposes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/netsim.html">netsim</a></span><span class="op">(</span><span class="va">est</span>, <span class="va">param</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="st">"raw.records"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Samuel Jenness, Steven M. Goodreau, Martina Morris, Adrien Le Guillou, Chad Klumb.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
