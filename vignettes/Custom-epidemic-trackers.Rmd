---
title: "Custom-epidemic-trackers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Custom-epidemic-trackers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(EpiModel)
```

# Introduction

In network models, we call *Epidemic Trackers* or *epi trackers* values stored
at each time step that informs the researcher on the state of the simulation.
These are for instance `s.num` or `i.num` that tell us how many *susceptible* and
*infected* there is in the model at each time step. If you are unfamiliar with
`EpiModel` use, please check the [EpiModel
tutorials](http://www.epimodel.org/tut.html). Examples of usage of *epi
trackers* can be found in [thi NME
course](https://statnet.org/nme/d3-s2-SISBasic.html#Epidemic_Simulation).

In predefined models, a few *epi trackers* are already defined. However, in
a real research project, the user has to define all the trackers he wants to
analyze inside its custom modules using `EpiModel::set_epi` function. When a
project becomes big enough like
[EpiModelHIV](https://github.com/statnet/EpiModelHIV), modifying the modules to
add new trackers can become a tedious and error-prone process.

In this vignette, we will explore the `trackers.net` optional module that allows
the user to pass trackers to the model just before runtime through the `control`
object.

# Trackers

What we call a **tracker** in this vignette is a `function` that takes `dat` and
`at` as arguments and outputs a scalar value. Every **tracker** is run by the
`trackers.net` module at each time step.

```{r tracker-example}
epi_s_num <- function(dat, at) {
  needed_attributes <- c("status")
  output <- with(get_attr_list(dat, needed_attributes), {
    out <- sum(status == "s", na.rm = TRUE)

    out
  })

  return(output)
}
```

The `epi_s_num` function defined above is a **tracker**. It calculates at each
time-step the number of *susceptible* in the network.

The next example **tracker** is calculate the proportion of the population that
is infected at each time step. Let's look what each element does:

```{r tracker-commented}
epi_prop_infected <- function(dat, at) {
  # we need two attributes for our calculation: `status` and `active`
  needed_attributes <- c("status", "active")

  # we use `with` to simplify code
  output <- with(get_attr_list(dat, needed_attributes), {
    pop <- active == 1      # we only look at active nodes
    cond <- status == "i"   # we want to know which are infected (status == "i")

    # how many are `infected` among the `active`
    out <- sum(cond & pop, na.rm = TRUE) / sum(pop, na.rm = TRUE)

    out
  })

  return(output)
}
```

We recommend that you always make your **trackers** as follows:

1. define a `needed_attributes` variable containing a vector of attribute
   names. (in this example: "status" and "active").
2. use `with` and `get_attr_list(dat, needed_attributes)` to work in an
   environment with only the objects you need. This helps to understand what
   the tracker does and simplify the debugging process. We save the result of
   this call into `output`
3. define `out` as the calculated outcome inside with, it MUST be a scalar. This
   is the last element evaluated by the `with` expression.
4. `return(output)`, what was calculated inside the `with` construct.

# Using the `trackers.net` module

This functionality is part of an optional module provided by `EpiModel`,
`trackers.net`. This module has to be enabled in `control.net`. And the
**trackers** themselves must be declared as a named list in `control.net`:
`tracker.list`.

```{r tracker-list}
# Create the `tracker.list` list
some.trackers <- list(
  prop_infected = epi_prop_infected,
  s_num         = epi_s_num
)

control <- control.net(
  type = NULL, # must be NULL as we use a custom module
  nsims = 2,
  nsteps = 5,
  verbose = FALSE,
  infection.FUN = infection.net,
  trackers.FUN = trackers.net,
  tracker.list = some.trackers
)
```

Each function has to be named in the `tracker.list` list. The name given there
will be used to identify the **tracker** in the `epi` list and will be the name
of the corresponding column of the `data.frame` produced by `as.data.frame(mod)`
where `mod` is a `netsim` object.

*Note*: in the `some.trackers` list, we put `epi_prop_infected` and `epi_s_num`
without parentheses at the end. This is because we store the `function` and not
the result of calling the function.

This is the minimal `control.net` to enable the module. Usually, a researcher
will want to add it to a more complex model with several bespoke modules. See the
"Advanced Extension Models" section in the
[EpiModel tutorials](http://www.epimodel.org/tut.html).

**Important**: when enabling the `trackers.net` module, the researcher must pay
particular attention to the order the modules are run. It is recommended to have
the `trackers.net` module run last so the tracked values will reflect the state
of the model at the end of the time step.

# Advanced usage

This way of defining trackers permits the use of [function
factories](https://adv-r.hadley.nz/function-factories.html) to easily define
multiple **trackers**.

```{r factories}
epi_s <- function(r_ind) {
  function(dat, at) {
    needed_attributes <- c("race", "status")
    output <- with(get_attr_list(dat, needed_attributes), {
      out <- sum(
        race %in% r_ind &
        status == "s",
        na.rm = TRUE
      )

      out
    })

    return(output)
  }
}

some.trackers <- list(
  s_1   = epi_s(1),
  s_2   = epi_s(2),
  s_3   = epi_s(3),
  s_ALL = epi_s(1:3)
)
```

Here `epi_s` is a function factory that outputs a tracker specific to the "races"
of interest. In `some.trackers` we defined 4 **trackers**, one for each "race"
(1 to 3) and a fourth one that counts all 3 at once.


```{r factories2}
epi_linked_time <- function(weeks) {
  function(dat, at) {
    needed_attributes <- c("tx.init.time", "diag.time")
    output <- with(get_attr_list(dat, needed_attributes), {
      out <- sum(tx.init.time - diag.time <= weeks, na.rm = TRUE)

      out
    })

    return(output)
  }
}

some.trackers <- list(
  linked_26w   = epi_linked_time(26),
  linked_52w   = epi_linked_time(52)
)
```

In this example, we want to track the number of individuals who started
treatment 26 and 52 weeks respectively after their diagnosis.
